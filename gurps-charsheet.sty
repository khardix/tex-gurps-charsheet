\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{gurps-charsheet}[2015/02/15 GURPS Character sheet Toolbox]

\RequirePackage[usenames,dvipsnames,table]{xcolor}
\RequirePackage{ifthen}
\RequirePackage{geometry}
\RequirePackage{tikz}
\RequirePackage{xkeyval}

% %%%%%%%%%%%%% Page Environments %%%%%%%%%%%%%

%% Two side column environment
\newcounter{TwoColEnv} %% Count usage of environment for tikz naming and targeting
\newenvironment{twosidecolumns}%
{\ignorespaces
  % === BEGIN Start  twosidecolumns ===
  \newcounter{LeftAttributes} % How many attributes are already in left column
  \newcounter{RightAttributes} % How many attributes are already in right column
  \newlength{\attrHeight}\setlength{\attrHeight}{2.5cm}

  % Set new geometry and make space for the columns
  \newgeometry{vmargin=1cm,hmargin=3.5cm,includefoot}
  % Calculate total column height
  \newlength{\colheight}\setlength{\colheight}{\paperheight}\addtolength{\colheight}{-2cm}
  % Draw the columns - at its base they are simple rectangles
  \begin{tikzpicture}[remember picture, overlay]
    \node[below right, shift={(1cm, -1cm)},inner sep=0pt](tc\theTwoColEnv-LeftCol) at (current page.north west)%
    {
      \tikz\draw[line width=1pt] (0cm, 0cm) rectangle (2.5cm, -1\colheight);
    };
    \node[below right, shift={(-3.5cm, -1cm)},inner sep=0pt](tc\theTwoColEnv-RightCol) at (current page.north east)%
    {
      \tikz\draw[line width=1pt] (0cm, 0cm) rectangle (2.5cm, -1\colheight);
    };
  \end{tikzpicture}

  % Define commands for inserting attributes into columns
  \newsavebox{\attrPoints}\newsavebox{\attrValue}
  \define@key{attribute}{points}[0]{%
    \savebox{\attrPoints}{{\color{gray}##1}}%
  }
  \define@key{attribute}{value}[10]{%
    \savebox{\attrValue}{\Huge ##1}%
  }
  \newcommand{\add@Attribute}[3][points,value]{
    \setkeys{attribute}{##1}%
    \begin{tikzpicture}[remember picture,overlay,name prefix=tc\theTwoColEnv-]
      % Node with attribute text - invisible frame
      \node[below,yshift=-\value{##2Attributes}\attrHeight,minimum size=\attrHeight,align=center,inner sep=0pt]
      (at\arabic{##2Attributes}) at (##2Col.north) {
        \textsc{\large ##3}\\[0pt]%
        [\hspace{1.5em}]\\[-1\baselineskip]
        \usebox{\attrPoints}\\[0.5em]%
        \usebox{\attrValue}
      };
      % Do not draw the separator line if this is the first attribute in column
      \ifthenelse{\value{##2Attributes} = 0}{}{
        \draw[line width=1pt] (at\arabic{##2Attributes}.north west) -- (at\arabic{##2Attributes}.north east);
      }
    \end{tikzpicture}%
    \savebox{\attrPoints}{}\savebox{\attrValue}{}%
    \stepcounter{##2Attributes}%
  }
  \newcommand{\addLeftAttribute}[2][points,value]{\add@Attribute[##1]{Left}{##2}}%
  \newcommand{\addRightAttribute}[2][points,value]{\add@Attribute[##1]{Right}{##2}}%
}% === END   Start  twosidecolumns ===
{\noindent\ignorespacesafterend
  % === BEGIN Finish twosidecolumns ===
  \restoregeometry
}% === END   Finish twosidecolumns ===

% %%%%%%%%%%%%% Character Attributes Management %%%%%%%%%%%%%

% Count running totals of invested points
\newcounter{GCS@attr@total}

% Each attribute is defined as having label, value and optional invested points.
% All of those are arbitrary text.
% - Label is human-readable name of the attribute (i. e. Dexterity or Swing)
% - Value is the numerical value of that attribute (i. e. 12 or 1d+1)
% - Points are points invested in the attribute

% Define keys for saving user input
\define@cmdkeys[GCS]{newAttribute}[GCS@na@]{points,value}
% Clean the keys
\def\GCS@na@value{} \def\GCS@na@points{}

\newcommand{\newAttribute}[3][]{%
  \setkeys[GCS]{newAttribute}{#1}%
  \expandafter\edef\csname GCS@attr@#2@label\endcsname{#3}%
  \expandafter\edef\csname GCS@attr@#2@value\endcsname{\GCS@na@value}%
  \expandafter\edef\csname GCS@attr@#2@points\endcsname{\GCS@na@points}%
  % add points to running total
  \addtocounter{GCS@attr@total}{0\GCS@na@points}%
  % clean used keys
  \def\GCS@na@value{} \def\GCS@na@points{}
}
\newcommand{\@attr}[2]{\csname GCS@attr@#1@#2\endcsname }
\newcommand{\attrLabel}[1]{\@attr{#1}{label}}
\newcommand{\attrValu}[1]{\@attr{#1}{value}}
\newcommand{\attrPoint}[1]{\@attr{#1}{points}}

\newcommand{\totalAttr}{\theGCS@attr@total}

\endinput
